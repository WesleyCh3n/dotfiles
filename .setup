#!/bin/sh
set -euo pipefail

install_package() {
  sudo apt-get update -qq -y && \
    sudo apt-get install -qq -y --no-install-recommends \
      curl zsh tmux unzip python3-venv
}

# tpm installation
install_tpm() {
  git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm
  $HOME/.tmux/plugins/tpm/scripts/install_plugins.sh
}

# mise installation
install_mise() {
  curl https://mise.run | sh
  zsh -c "source $HOME/.zshrc && mise install && npm install -g yarn"
}

dotfiles_link() {
  find "$SOURCE_DIR" -maxdepth 1 -type d ! -path "$SOURCE_DIR" -print0 | while IFS= read -r -d $'\0' folder_path; do
    folder_name=$(basename "$folder_path")
    link_name="${LINK_PREFIX}${folder_name}"
    link_path="${TARGET_DIR}/${link_name}"

    # Check if the link already exists
    if [ -e "$link_path" ]; then
      echo "Warning: Link '$link_path' already exists. Skipping."
      continue  # Move to the next folder
    fi

    # Create the soft link (or simulate it)
    if [ "$DRY_RUN" = "true" ]; then
      echo "Dry run: Would create link: ln -s \"$folder_path\" \"$link_path\""
    else
      ln -s "$folder_path" "$link_path"
      if [ $? -eq 0 ]; then
        echo "Created link: $link_path -> $folder_path"
      else
        echo "Error: Failed to create link: $link_path -> $folder_path"
      fi
    fi
  done
}

dotfiles_init() {
  mkdir -p $1
  git --no-replace-objects clone --bare --depth 1 \
      https://github.com/WesleyCh3n/dotfiles.git $1/.dot;
  git --work-tree $1 --git-dir $1/.dot config --local status.showUntrackedFiles no;
  git --work-tree $1 --git-dir $1/.dot checkout -f
}

main() {
  echo "1: " $1

  if [ "$1" == "link" ]; then
    echo "Starting the process..."
  fi

  install_package

  install_tpm
  install_mise
}

main $@
