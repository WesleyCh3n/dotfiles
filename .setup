#!/bin/bash
set -euo pipefail

install_package() {
  sudo apt-get update -qq -y && \
    sudo apt-get install -qq -y --no-install-recommends \
      curl zsh tmux unzip python3-venv
}

# tpm installation
install_tpm() {
  git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm
  $HOME/.tmux/plugins/tpm/scripts/install_plugins.sh
}

# mise installation
install_mise() {
  curl https://mise.run | sh
  zsh -c "source $HOME/.zshrc"
  zsh -c "mise trust $(realpath $HOME/.config/mise/mise.toml) && mise install"
  zsh -c "npm install -g yarn"
}

dotfiles_link() {
  if [ -e "$HOME/.zshrc" ]; then
    echo "Warning: $HOME/.zshrc exists. Skipping."
  else
    ln -s $(pwd)/.zshrc $HOME/.zshrc
  fi

  mkdir -p $HOME/.docker
  if [ -e "$HOME/.docker/config.json" ]; then
    echo "Warning: $HOME/.docker/config.json exists. Skipping."
  else
    ln -s $(pwd)/.docker/config.json $HOME/.docker/config.json
  fi

  mkdir -p $HOME/.local/bin/
  for item in $(find .local/bin -maxdepth 1 ! -path .local/bin); do
    target=$HOME/.local/bin/$(basename $item)
    if [ -e "$target" ]; then
      echo "Warning: $target exists. Skipping."
      continue
    fi
    ln -s $item $target
  done


  config_dir=$(pwd)/.config
  mkdir -p $HOME/.config
  for dir in $(find $config_dir -maxdepth 1 -type d ! -path $config_dir); do
    target=$HOME/.config/$(basename $dir)
    if [ -e "$target" ]; then
      echo "Warning: $target exists. Skipping."
      continue
    fi
    ln -s "$dir" "$target"
    if [ $? -eq 0 ]; then
      echo "Created link: $target -> $dir"
    else
      echo "Error: Failed to create link: $target -> $dir"
    fi
  done
}

dotfiles_init() {
  mkdir -p $1
  git --no-replace-objects clone --bare --depth 1 \
      https://github.com/WesleyCh3n/dotfiles.git $1/.dot;
  git --work-tree $1 --git-dir $1/.dot config --local status.showUntrackedFiles no;
  git --work-tree $1 --git-dir $1/.dot checkout -f
}

main() {
  install_package

  if [ "$1" == "link" ]; then
    dotfiles_link
  fi

  install_tpm
  install_mise
}

main link
